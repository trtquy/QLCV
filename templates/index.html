{% extends "base.html" %}

{% block title %}Banking Task Board - TaskFlow{% endblock %}

{% block extra_head %}
<script>
// Define edit function globally before page loads
function openTaskEditModal(taskId) {
    // Find task data
    var task = null;
    if (window.tasksData) {
        for (var i = 0; i < window.tasksData.length; i++) {
            if (window.tasksData[i].id == taskId) {
                task = window.tasksData[i];
                break;
            }
        }
    }
    
    if (!task) {
        alert('Task not found');
        return;
    }
    
    // Wait for DOM to be ready
    setTimeout(function() {
        // Set form values
        document.getElementById('edit_title').value = task.title || '';
        document.getElementById('edit_description').value = task.description || '';
        document.getElementById('edit_priority').value = task.priority || 'medium';
        document.getElementById('edit_complexity').value = task.complexity || 'medium';
        document.getElementById('edit_status').value = task.status || 'todo';
        document.getElementById('edit_assignee_id').value = task.assignee_id || '';
        document.getElementById('edit_team_id').value = task.team_id || '';
        document.getElementById('edit_estimated_hours').value = task.estimated_hours || '';
        
        // Set date fields
        document.getElementById('edit_started_at').value = task.started_at ? task.started_at.split('T')[0] : '';
        document.getElementById('edit_due_date').value = task.due_date ? task.due_date.split('T')[0] : '';
        document.getElementById('edit_completed_at').value = task.completed_at ? task.completed_at.split('T')[0] : '';
        
        // Set form action
        document.getElementById('editTaskForm').action = '/update_task/' + taskId;
        
        // Show modal
        var modalEl = document.getElementById('editTaskModal');
        if (modalEl && bootstrap && bootstrap.Modal) {
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }, 100);
}

// Initialize task data early
window.tasksData = [
    {% for task in todo_tasks + in_progress_tasks + completed_tasks %}
    {
        id: "{{ task.id }}",
        title: "{{ task.title|e }}",
        description: "{{ task.description|e if task.description else '' }}",
        status: "{{ task.status }}",
        priority: "{{ task.priority }}",
        complexity: "{{ task.complexity if task.complexity else 'medium' }}",
        assignee_id: "{{ task.assignee_id if task.assignee_id else '' }}",
        team_id: "{{ task.team_id if task.team_id else '' }}",
        estimated_hours: "{{ task.estimated_hours if task.estimated_hours else '' }}",
        started_at: "{{ task.started_at.isoformat() if task.started_at else '' }}",
        due_date: "{{ task.due_date.isoformat() if task.due_date else '' }}",
        completed_at: "{{ task.completed_at.isoformat() if task.completed_at else '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
</script>
<style>
    .kanban-column {
        min-height: 600px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .task-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid #0052CC;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .priority-urgent { border-left-color: #FF5630; }
    .priority-high { border-left-color: #FF8B00; }
    .priority-medium { border-left-color: #36B37E; }
    .priority-low { border-left-color: #0065FF; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-1">Banking Task Board</h1>
                    <p class="text-muted mb-0">Manage your banking operations efficiently</p>
                </div>
                {% if current_user and current_user.role in ['manager', 'admin'] %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                    <i data-feather="plus" class="me-2"></i>
                    Create New Task
                </button>
                {% else %}
                <div class="text-muted">
                    <i data-feather="info" class="me-2"></i>
                    Only managers can create tasks
                </div>
                {% endif %}
            </div>
            
            <!-- Team Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i data-feather="filter"></i></span>
                        <select class="form-select" id="teamFilter">
                            <option value="">All Banking Teams</option>
                            {% for team in teams %}
                                <option value="{{ team.id }}" {% if selected_team == team.id|string %}selected{% endif %}>
                                    {{ team.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    {% if current_user and current_user.role == 'analyst' %}
                    <div class="input-group">
                        <span class="input-group-text"><i data-feather="user"></i></span>
                        <select class="form-select" id="myTasksFilter">
                            <option value="">All Tasks</option>
                            <option value="my-tasks">My Tasks Only</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center gap-3">
                        {% if selected_team %}
                            {% for team in teams %}
                                {% if team.id|string == selected_team %}
                                    <div class="badge bg-primary">
                                        <i data-feather="users" class="me-1" style="width: 12px; height: 12px;"></i>
                                        {{ team.name }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <small class="text-muted">
                            Showing {{ (todo_tasks + in_progress_tasks + in_review_tasks + completed_tasks)|length }} tasks
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="row g-4">
        <!-- Todo Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-secondary">
                        <i data-feather="circle" class="me-2"></i>
                        To Do
                    </h5>
                    <span class="badge bg-secondary">{{ todo_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in todo_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openTaskEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-primary ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-warning">
                        <i data-feather="clock" class="me-2"></i>
                        In Progress
                    </h5>
                    <span class="badge bg-warning">{{ in_progress_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in in_progress_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openTaskEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-warning ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                                
                                <!-- Send for Review Button for Analysts -->
                                {% if current_user and current_user.role == 'analyst' and task.assignee_id == current_user.id %}
                                <div class="mt-2">
                                    <form method="POST" action="{{ url_for('send_task_for_review', task_id=task.id) }}" class="d-inline" onclick="event.stopPropagation();">
                                        <button type="submit" class="btn btn-sm btn-info" title="Send for Review">
                                            <i data-feather="send" style="width: 12px; height: 12px;"></i>
                                            Send for Review
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- In Review Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-info">
                        <i data-feather="eye" class="me-2"></i>
                        In Review
                    </h5>
                    <span class="badge bg-info">{{ in_review_tasks|length }}</span>
                </div>
                
                <div class="task-container" data-status="in_review">
                    {% for task in in_review_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openTaskEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-info ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    {% if task.supervisor %}
                                        <small class="text-muted">Supervisor: {{ task.supervisor.display_name or task.supervisor.username }}</small>
                                    {% endif %}
                                </div>
                                
                                <!-- Action buttons for In Review tasks -->
                                <div class="mt-2">
                                    <!-- Recall button for analysts -->
                                    {% if current_user and current_user.role == 'analyst' and task.assignee_id == current_user.id %}
                                    <form method="POST" action="{{ url_for('recall_task', task_id=task.id) }}" class="d-inline me-1" onclick="event.stopPropagation();">
                                        <button type="submit" class="btn btn-sm btn-warning" title="Recall from Review">
                                            <i data-feather="arrow-left" style="width: 12px; height: 12px;"></i>
                                            Recall
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Approve button for managers/directors -->
                                    {% if current_user and current_user.role in ['manager', 'director'] and task.team_id == current_user.team_id %}
                                    <form method="POST" action="{{ url_for('approve_task', task_id=task.id) }}" class="d-inline" onclick="event.stopPropagation();">
                                        <button type="submit" class="btn btn-sm btn-success" title="Approve & Complete">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                            Approve
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Completed Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-success">
                        <i data-feather="check-circle" class="me-2"></i>
                        Completed
                    </h5>
                    <span class="badge bg-success">{{ completed_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in completed_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openTaskEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-success ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Create New Task</h4>
                    <p class="text-muted small mb-0">Add a task to your banking workflow</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" action="{{ url_for('create_task') }}" id="createTaskForm">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    

                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="assignee_id" class="form-label fw-medium mb-2">Assign To</label>
                                <select class="form-select clean-input" id="assignee_id" name="assignee_id">
                                    <option value="">Select team member...</option>
                                    {% if current_user and current_user.team %}
                                        {% for user in users %}
                                            {% if user.team_id == current_user.team_id %}
                                                <option value="{{ user.id }}">{{ user.display_name or user.username }} ({{ user.role|title }})</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Supervisor -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="supervisor_id" class="form-label fw-medium mb-2">
                                    <i data-feather="user-check" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Supervisor
                                </label>
                                <select class="form-select clean-input" id="supervisor_id" name="supervisor_id">
                                    <option value="">Select supervisor...</option>
                                    {% if current_user and current_user.team %}
                                        {% for user in users %}
                                            {% if user.team_id == current_user.team_id and user.role == 'manager' %}
                                                <option value="{{ user.id }}">{{ user.display_name or user.username }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <div class="form-text">Optional: Choose a team manager to supervise this task</div>
                            </div>
                            
                            <!-- Team automatically set to manager's team -->
                            {% if current_user and current_user.team %}
                            <div class="mb-4">
                                <label class="form-label fw-medium mb-2">Banking Team</label>
                                <div class="form-control clean-input bg-light text-muted">
                                    <i data-feather="users" class="me-2" style="width: 16px; height: 16px;"></i>
                                    {{ current_user.team.name }} (Auto-assigned)
                                </div>
                                <div class="form-text">Tasks are automatically assigned to your team</div>
                            </div>
                            {% endif %}
                            
                            <div class="mb-4">
                                <label for="estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="estimated_hours" 
                                       name="estimated_hours" min="0.5" max="200" step="0.5" 
                                       placeholder="e.g. 4.5">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                        
                        <!-- Start Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="started_at" class="form-label fw-medium mb-2">
                                    <i data-feather="play-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control clean-input" id="started_at" 
                                       name="started_at">
                                <div class="form-text">When work on this task will begin</div>
                            </div>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="due_date" class="form-label fw-medium mb-2">
                                    <i data-feather="calendar" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Due Date
                                </label>
                                <input type="date" class="form-control clean-input" id="due_date" 
                                       name="due_date">
                                <div class="form-text">Target completion date</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Edit Task</h4>
                    <p class="text-muted small mb-0">Update task details</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" id="editTaskForm">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="edit_title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="edit_title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="edit_description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="edit_description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="edit_priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="edit_complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium">Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_status" class="form-label fw-medium mb-2">Status</label>
                                <select class="form-select clean-input" id="edit_status" name="task_status">
                                    <option value="todo">To Do</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="in_review">In Review</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_assignee_id" class="form-label fw-medium mb-2">Assign To</label>
                                <select class="form-select clean-input" id="edit_assignee_id" name="assignee_id">
                                    <option value="">Select team member...</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Supervisor -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_supervisor_id" class="form-label fw-medium mb-2">
                                    <i data-feather="user-check" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Supervisor
                                </label>
                                <select class="form-select clean-input" id="edit_supervisor_id" name="supervisor_id">
                                    <option value="">Select supervisor...</option>
                                    {% for user in users %}
                                        {% if user.role == 'manager' %}
                                            <option value="{{ user.id }}">{{ user.display_name or user.username }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Team Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_team_id" class="form-label fw-medium mb-2">Banking Team</label>
                                <select class="form-select clean-input" id="edit_team_id" name="team_id">
                                    <option value="">Select team...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Time Estimate -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="edit_estimated_hours" 
                                       name="estimated_hours" min="0.5" max="200" step="0.5" 
                                       placeholder="e.g. 4.5">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                        
                        <!-- Start Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_started_at" class="form-label fw-medium mb-2">
                                    <i data-feather="play-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_started_at" 
                                       name="started_at">
                                <div class="form-text">When work on this task began</div>
                            </div>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_due_date" class="form-label fw-medium mb-2">
                                    <i data-feather="calendar" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Due Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_due_date" 
                                       name="due_date">
                                <div class="form-text">Target completion date</div>
                            </div>
                        </div>
                        
                        <!-- Completed Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_completed_at" class="form-label fw-medium mb-2">
                                    <i data-feather="check-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Completed Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_completed_at" 
                                       name="completed_at" readonly>
                                <div class="form-text">Automatically set when task is completed</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn">
                        <i data-feather="trash-2" class="me-1" style="width: 16px; height: 16px;"></i>
                        Delete
                    </button>
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Update Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Clean Modal Styling */
.clean-modal {
    border: none;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
}

.clean-modal .modal-header {
    padding: 2rem 2rem 1rem 2rem;
}

.clean-modal .modal-body {
    padding: 0 2rem;
}

.clean-modal .modal-footer {
    padding: 1rem 2rem 2rem 2rem;
}

/* Clean Input Styling */
.clean-input {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #fff;
}

.clean-input:focus {
    border-color: #0052CC;
    box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    outline: none;
}

.clean-input::placeholder {
    color: #9ca3af;
}

/* Form Labels */
.form-label.fw-medium {
    color: #374151;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

/* Template Buttons */
.template-btn {
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.template-btn:hover {
    transform: translateY(-1px);
}

/* Priority Button Styling */
.btn-check:checked + .btn {
    transform: none;
}

.btn-outline-secondary:hover,
.btn-outline-success:hover,
.btn-outline-warning:hover,
.btn-outline-danger:hover {
    transform: translateY(-1px);
}

/* Modal Animation */
.modal.fade .modal-dialog {
    transform: scale(0.95);
    transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: scale(1);
}

/* Clean Button Styling */
.btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn-primary {
    background: #0052CC;
    border-color: #0052CC;
}

.btn-primary:hover {
    background: #003d99;
    border-color: #003d99;
}

.btn-light {
    background: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.btn-light:hover {
    background: #e9ecef;
    border-color: #dfe3e8;
    color: #495057;
}
</style>

<script>
// Welcome animation for successful login
// Set current user ID for JavaScript filtering
window.currentUserId = '{{ current_user.id if current_user else "" }}';

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're coming from a successful login
    const urlParams = new URLSearchParams(window.location.search);
    const fromLogin = urlParams.get('welcome') === 'true' || sessionStorage.getItem('loginSuccess') === 'true';
    
    if (fromLogin) {
        // Clear the session storage flag
        sessionStorage.removeItem('loginSuccess');
        
        // Add page entrance animation
        document.body.classList.add('page-enter');
        
        // Trigger the animation
        setTimeout(() => {
            document.body.classList.add('page-enter-active');
        }, 50);
        
        // Clean up URL parameter
        if (urlParams.get('welcome')) {
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }
    }
});

// Team filtering is now handled by event listener in DOMContentLoaded

// Task creation templates
const templates = {
    risk: {
        title: "Risk Assessment - Q4 Portfolio Review",
        description: "Conduct comprehensive risk analysis including risk identification, impact assessment, mitigation strategies, and compliance verification."
    },
    compliance: {
        title: "Compliance Review - Regulatory Requirements",
        description: "Perform regulatory compliance review including policy validation, control testing, gap analysis, and compliance reporting."
    },
    analysis: {
        title: "Market Analysis - VaR Calculations",
        description: "Execute market risk analysis including data validation, VaR calculations, stress testing, and portfolio performance analysis."
    },
    audit: {
        title: "Audit Task - Control Evaluation",
        description: "Complete audit procedures including documentation review, control assessment, sample testing, and finding documentation."
    }
};

// Clean modal functionality
function initializeModal() {
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    
    // Template button handlers
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const template = templates[this.dataset.template];
            if (template) {
                titleInput.value = template.title;
                descriptionInput.value = template.description;
            }
        });
    });
    
    // Form submission with loading state
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
        submitBtn.disabled = true;
    });
    
    // Reset form when modal is hidden
    document.getElementById('createTaskModal').addEventListener('hidden.bs.modal', function() {
        const form = document.getElementById('createTaskForm');
        form.reset();
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = 'Create Task';
        submitBtn.disabled = false;
    });
}





// Delete task functionality
function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete_task/' + taskId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Handle delete button click
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteTaskBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const form = document.getElementById('editTaskForm');
            if (form) {
                const taskId = form.action.split('/').pop();
                deleteTask(taskId);
            }
        });
    }
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    initializeModal();
    
    // Initialize kanban if function exists
    if (typeof initializeKanban === 'function') {
        initializeKanban();
    }
    
    // Setup edit functionality
    console.log('Setting up edit functionality');
    setupEditHandlers();
    
    // Setup team filter
    const teamFilter = document.getElementById('teamFilter');
    if (teamFilter) {
        teamFilter.addEventListener('change', function() {
            if (this.value) {
                window.location.href = '/?team=' + this.value;
            } else {
                window.location.href = '/';
            }
        });
    }
});

// Setup edit handlers function
function setupEditHandlers() {
    document.addEventListener('click', function(e) {
        const taskCard = e.target.closest('.task-card');
        if (taskCard && !e.target.closest('button')) {
            e.preventDefault();
            const taskId = taskCard.dataset.taskId;
            console.log('Task card clicked, ID:', taskId);
            if (taskId) {
                openTaskEditModal(taskId);
            }
        }
    });
}


</script>

<!-- Kanban Board JavaScript -->
<script src="{{ url_for('static', filename='js/kanban.js') }}"></script>
{% endblock %}