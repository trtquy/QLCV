{% extends "base.html" %}

{% block title %}Banking Task Board - TaskFlow{% endblock %}

{# Macro for priority badge with permission checking #}
{% macro priority_badge(task, current_user) %}
    {% set can_edit_priority = current_user and (
        current_user.is_administrator or 
        task.assignee_id == current_user.id or 
        task.created_by == current_user.id or 
        (current_user.role in ['manager', 'director'] and task.team_id == current_user.team_id)
    ) %}
    <div class="priority-selector ms-2" onclick="event.stopPropagation();">
        <span class="badge priority-badge priority-{{ task.priority }} {% if not can_edit_priority %}priority-disabled{% endif %}" 
              data-task-id="{{ task.id }}" 
              data-current-priority="{{ task.priority }}"
              {% if can_edit_priority %}
              onclick="cyclePriority(this)"
              title="Click to change priority ({{ task.priority|upper }} â†’ {% if task.priority == 'low' %}MEDIUM{% elif task.priority == 'medium' %}HIGH{% elif task.priority == 'high' %}URGENT{% else %}LOW{% endif %})"
              {% else %}
              title="Priority: {{ task.priority|upper }} (read-only - only assignees, creators, team managers, or administrators can change)"
              {% endif %}>
            {{ task.priority|upper }}
            {% if can_edit_priority %}
            <i class="fas fa-chevron-down ms-1" style="font-size: 10px;"></i>
            {% else %}
            <i class="fas fa-lock ms-1" style="font-size: 9px; opacity: 0.7;"></i>
            {% endif %}
        </span>
    </div>
{% endmacro %}

{# Macro for time tracking section #}
{% macro time_tracking_section(task, current_user) %}
    {% set total_logged = task.get_total_time_logged() %}
    {% set can_track_time = current_user and (task.assignee_id == current_user.id or current_user.is_administrator) %}
    
    <div class="time-tracking-section mt-2 mb-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                {% if task.estimated_hours %}
                    {{ "%.1f"|format(total_logged or 0) }}h / {{ "%.1f"|format(task.estimated_hours) }}h
                {% else %}
                    {{ "%.1f"|format(total_logged or 0) }}h logged
                {% endif %}
            </small>
            {% if can_track_time %}
            <div class="time-controls">
                <button class="btn btn-sm btn-outline-primary time-track-btn" 
                        data-task-id="{{ task.id }}"
                        onclick="event.stopPropagation(); toggleTimeTracking('{{ task.id }}')">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            {% endif %}
        </div>
        {% if task.estimated_hours and total_logged %}
            {% set progress_percent = ((total_logged / task.estimated_hours) * 100)|round(1) %}
            <div class="progress" style="height: 3px;">
                <div class="progress-bar {% if progress_percent > 100 %}bg-danger{% elif progress_percent > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                     style="width: {{ [progress_percent, 100]|min }}%"
                     title="{{ progress_percent }}% complete"></div>
            </div>
        {% endif %}
    </div>
{% endmacro %}

{# Macro for approval/rejection buttons for tasks in review #}
{% macro approval_section(task, current_user) %}
    {% if task.status == 'in_review' and current_user and task.supervisor_id == current_user.id %}
    <div class="approval-section mt-2 mb-2 pt-2" style="border-top: 1px solid #e9ecef;">
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" 
                    onclick="event.stopPropagation(); approveTask('{{ task.id }}')"
                    title="Approve and complete task">
                <i class="fas fa-check me-1"></i>Approve
            </button>
            <button class="btn btn-sm btn-warning" 
                    onclick="event.stopPropagation(); rejectTask('{{ task.id }}')"
                    title="Reject and send back to in progress">
                <i class="fas fa-times me-1"></i>Reject
            </button>
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% block extra_head %}
<script>
// Simple wrapper function
function loadTaskForEdit(taskId) {
    // Find task data
    var task = null;
    if (window.tasksData) {
        for (var i = 0; i < window.tasksData.length; i++) {
            if (window.tasksData[i].id == taskId) {
                task = window.tasksData[i];
                break;
            }
        }
    }
    
    if (!task) {
        alert('Task not found');
        return;
    }
    
    // Wait for DOM to be ready
    setTimeout(function() {
        // Set basic form values
        var titleEl = document.getElementById('edit_title');
        var descEl = document.getElementById('edit_description');
        var priorityEl = document.getElementById('edit_priority');
        var complexityEl = document.getElementById('edit_complexity');
        var teamEl = document.getElementById('edit_team_id');
        var estimatedEl = document.getElementById('edit_estimated_hours');
        var assigneeIdEl = document.getElementById('edit_assignee_id');
        var supervisorIdEl = document.getElementById('edit_supervisor_id');
        
        if (titleEl) titleEl.value = task.title || '';
        if (descEl) descEl.value = task.description || '';
        if (priorityEl) priorityEl.value = task.priority || 'medium';
        if (complexityEl) complexityEl.value = task.complexity || 'medium';
        if (teamEl) teamEl.value = task.team_id || '';
        if (estimatedEl) estimatedEl.value = task.estimated_hours || '';
        if (assigneeIdEl) assigneeIdEl.value = task.assignee_id || '';
        if (supervisorIdEl) supervisorIdEl.value = task.supervisor_id || '';
        
        // Set date fields
        var startedAtEl = document.getElementById('edit_started_at');
        var dueDateEl = document.getElementById('edit_due_date');
        var completedAtEl = document.getElementById('edit_completed_at');
        
        if (startedAtEl) startedAtEl.value = task.started_at ? task.started_at.split('T')[0] : '';
        if (dueDateEl) dueDateEl.value = task.due_date ? task.due_date.split('T')[0] : '';
        if (completedAtEl) completedAtEl.value = task.completed_at ? task.completed_at.split('T')[0] : '';
        
        // Set form action
        var form = document.getElementById('editTaskForm');
        if (form) form.action = '/update_task/' + taskId;
        
        // Show modal
        var modalEl = document.getElementById('editTaskModal');
        if (modalEl && bootstrap && bootstrap.Modal) {
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    }, 100);
}

// One-click priority cycling function
function cyclePriority(badgeElement) {
    // Check if badge is disabled
    if (badgeElement.classList.contains('priority-disabled')) {
        return; // Do nothing for disabled badges
    }
    
    var taskId = badgeElement.getAttribute('data-task-id');
    var currentPriority = badgeElement.getAttribute('data-current-priority');
    
    // Priority cycle: low -> medium -> high -> urgent -> low
    var priorityOrder = ['low', 'medium', 'high', 'urgent'];
    var currentIndex = priorityOrder.indexOf(currentPriority);
    var nextIndex = (currentIndex + 1) % priorityOrder.length;
    var newPriority = priorityOrder[nextIndex];
    
    // Show loading state
    badgeElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    badgeElement.className = 'badge priority-badge priority-loading';
    
    // Send AJAX request to update priority
    fetch('/update_task_priority/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'priority=' + encodeURIComponent(newPriority)
    })
    .then(function(response) {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to update priority');
    })
    .then(function(data) {
        // Update badge display
        badgeElement.innerHTML = newPriority.toUpperCase() + ' <i class="fas fa-chevron-down ms-1" style="font-size: 10px;"></i>';
        badgeElement.className = 'badge priority-badge priority-' + newPriority;
        badgeElement.setAttribute('data-current-priority', newPriority);
        
        // Update task card border color
        var taskCard = badgeElement.closest('.task-card');
        if (taskCard) {
            // Remove old priority classes and add new one
            taskCard.classList.remove('priority-urgent', 'priority-high', 'priority-medium', 'priority-low');
            taskCard.classList.add('priority-' + newPriority);
        }
        
        // Update local task data
        if (window.tasksData) {
            for (var i = 0; i < window.tasksData.length; i++) {
                if (window.tasksData[i].id == taskId) {
                    window.tasksData[i].priority = newPriority;
                    break;
                }
            }
        }
        
        // Show success notification
        showPriorityNotification('Priority updated to ' + newPriority.toUpperCase(), 'success');
    })
    .catch(function(error) {
        // Restore original state on error
        badgeElement.innerHTML = currentPriority.toUpperCase() + ' <i class="fas fa-chevron-down ms-1" style="font-size: 10px;"></i>';
        badgeElement.className = 'badge priority-badge priority-' + currentPriority;
        showPriorityNotification('Failed to update priority', 'error');
    });
}

// Show priority notification
function showPriorityNotification(message, type) {
    var notification = document.createElement('div');
    notification.className = 'priority-notification priority-notification-' + type;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(function() {
        notification.classList.add('show');
    }, 10);
    
    // Hide and remove notification
    setTimeout(function() {
        notification.classList.remove('show');
        setTimeout(function() {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

// Enhanced time tracking functionality
function toggleTimeTracking(taskId) {
    var button = document.querySelector('[data-task-id="' + taskId + '"].time-track-btn');
    var taskCard = button.closest('.task-card');
    
    if (button.classList.contains('active')) {
        stopTimeTracking(taskId, button, taskCard);
    } else {
        startTimeTracking(taskId, button, taskCard);
    }
}

function startTimeTracking(taskId, button, taskCard) {
    // First stop any other active tracking
    var activeButtons = document.querySelectorAll('.time-track-btn.active');
    activeButtons.forEach(function(activeBtn) {
        var activeTaskCard = activeBtn.closest('.task-card');
        var activeTaskId = activeBtn.getAttribute('data-task-id');
        stopTimeTracking(activeTaskId, activeBtn, activeTaskCard, true);
    });
    
    // Start tracking for this task
    fetch('/start_time_tracking/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(function(response) {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to start time tracking');
    })
    .then(function(data) {
        button.classList.add('active');
        button.innerHTML = '<i class="fas fa-stop"></i>';
        button.title = 'Stop tracking time';
        taskCard.classList.add('time-tracking-active');
        
        // Store the time log ID for stopping later
        button.setAttribute('data-time-log-id', data.time_log_id);
        
        showPriorityNotification('Time tracking started', 'success');
        
        // Start the timer display
        startTimerDisplay(taskId, button);
    })
    .catch(function(error) {
        showPriorityNotification('Failed to start time tracking', 'error');
    });
}

function stopTimeTracking(taskId, button, taskCard, silent) {
    var timeLogId = button.getAttribute('data-time-log-id');
    
    if (!timeLogId) {
        console.warn('No time log ID found for task', taskId);
        return;
    }
    
    fetch('/stop_time_tracking/' + timeLogId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(function(response) {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to stop time tracking');
    })
    .then(function(data) {
        button.classList.remove('active');
        button.innerHTML = '<i class="fas fa-play"></i>';
        button.title = 'Start tracking time';
        taskCard.classList.remove('time-tracking-active');
        button.removeAttribute('data-time-log-id');
        
        // Update the time display
        updateTimeDisplay(taskId, data.total_time);
        
        if (!silent) {
            showPriorityNotification('Time tracking stopped: ' + data.duration + ' hours logged', 'success');
        }
        
        // Stop the timer display
        stopTimerDisplay(taskId);
    })
    .catch(function(error) {
        if (!silent) {
            showPriorityNotification('Failed to stop time tracking', 'error');
        }
    });
}

function startTimerDisplay(taskId, button) {
    var startTime = new Date();
    
    var timer = setInterval(function() {
        var now = new Date();
        var elapsed = (now - startTime) / 1000 / 60 / 60; // hours
        button.title = 'Stop tracking time (running: ' + elapsed.toFixed(1) + 'h)';
    }, 60000); // Update every minute
    
    // Store timer ID for cleanup
    button.setAttribute('data-timer-id', timer);
}

function stopTimerDisplay(taskId) {
    var button = document.querySelector('[data-task-id="' + taskId + '"].time-track-btn');
    var timerId = button.getAttribute('data-timer-id');
    
    if (timerId) {
        clearInterval(parseInt(timerId));
        button.removeAttribute('data-timer-id');
    }
}

function updateTimeDisplay(taskId, totalTime) {
    var taskCard = document.querySelector('[data-task-id="' + taskId + '"]').closest('.task-card');
    var timeDisplay = taskCard.querySelector('.time-tracking-section .text-muted');
    
    if (timeDisplay && totalTime !== undefined) {
        var timeText = timeDisplay.textContent;
        // Update the logged time part
        var newTimeText = timeText.replace(/[\d.]+h/, totalTime.toFixed(1) + 'h');
        timeDisplay.textContent = newTimeText;
        
        // Update progress bar if it exists
        var progressBar = taskCard.querySelector('.progress-bar');
        if (progressBar) {
            var estimated = parseFloat(timeText.match(/\/\s*([\d.]+)h/)[1]);
            var progressPercent = (totalTime / estimated) * 100;
            progressBar.style.width = Math.min(progressPercent, 100) + '%';
            progressBar.title = progressPercent.toFixed(1) + '% complete';
            
            // Update progress bar color
            if (progressPercent > 100) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (progressPercent > 80) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-success';
            }
        }
    }
}

// Initialize task data early
window.tasksData = [
    {% for task in todo_tasks + in_progress_tasks + in_review_tasks + completed_tasks %}
    {
        id: "{{ task.id }}",
        title: "{{ task.title|e }}",
        description: "{{ task.description|e if task.description else '' }}",
        status: "{{ task.status }}",
        priority: "{{ task.priority }}",
        complexity: "{{ task.complexity if task.complexity else 'medium' }}",
        assignee_id: "{{ task.assignee_id if task.assignee_id else '' }}",
        supervisor_id: "{{ task.supervisor_id if task.supervisor_id else '' }}",
        team_id: "{{ task.team_id if task.team_id else '' }}",
        estimated_hours: {{ task.estimated_hours if task.estimated_hours else 'null' }},
        total_logged: {{ task.get_total_time_logged() or 0 }},
        started_at: "{{ task.started_at.isoformat() if task.started_at else '' }}",
        due_date: "{{ task.due_date.isoformat() if task.due_date else '' }}",
        completed_at: "{{ task.completed_at.isoformat() if task.completed_at else '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Initialize time tracking when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeTimeTrackingUI();
    checkActiveTimeLog();
});

function initializeTimeTrackingUI() {
    window.tasksData.forEach(function(task) {
        addTimeTrackingToCard(task);
    });
}

function addTimeTrackingToCard(task) {
    var taskCard = document.querySelector('[data-task-id="' + task.id + '"]');
    if (!taskCard) return;
    
    var cardBody = taskCard.querySelector('.card-body');
    var existingTimeSection = cardBody.querySelector('.time-tracking-section');
    
    if (existingTimeSection) return;
    
    // Check if user can track time for this task
    var currentUserId = "{{ current_user.id if current_user else '' }}";
    var isAdmin = {{ 'true' if current_user and current_user.is_administrator else 'false' }};
    var canTrackTime = isAdmin || (task.assignee_id === currentUserId);
    
    // Create time tracking section
    var timeSection = document.createElement('div');
    timeSection.className = 'time-tracking-section mt-2 mb-2';
    
    var timeInfo = document.createElement('div');
    timeInfo.className = 'd-flex justify-content-between align-items-center mb-1';
    
    var timeDisplay = document.createElement('small');
    timeDisplay.className = 'text-muted';
    
    var timeText = task.total_logged.toFixed(1) + 'h logged';
    if (task.estimated_hours) {
        timeText = task.total_logged.toFixed(1) + 'h / ' + task.estimated_hours.toFixed(1) + 'h';
    }
    
    timeDisplay.innerHTML = '<i class="fas fa-clock me-1"></i>' + timeText;
    timeInfo.appendChild(timeDisplay);
    
    if (canTrackTime) {
        var timeControls = document.createElement('div');
        timeControls.className = 'time-controls';
        
        var trackBtn = document.createElement('button');
        trackBtn.className = 'btn btn-sm btn-outline-primary time-track-btn';
        trackBtn.setAttribute('data-task-id', task.id);
        trackBtn.innerHTML = '<i class="fas fa-play"></i>';
        trackBtn.title = 'Start tracking time';
        trackBtn.onclick = function(e) {
            e.stopPropagation();
            toggleTimeTracking(task.id);
        };
        
        timeControls.appendChild(trackBtn);
        timeInfo.appendChild(timeControls);
    }
    
    timeSection.appendChild(timeInfo);
    
    // Add progress bar if estimated hours exist
    if (task.estimated_hours && task.total_logged > 0) {
        var progressPercent = (task.total_logged / task.estimated_hours) * 100;
        var progressDiv = document.createElement('div');
        progressDiv.className = 'progress';
        progressDiv.style.height = '3px';
        
        var progressBar = document.createElement('div');
        if (progressPercent > 100) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (progressPercent > 80) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
        progressBar.style.width = Math.min(progressPercent, 100) + '%';
        progressBar.title = progressPercent.toFixed(1) + '% complete';
        
        progressDiv.appendChild(progressBar);
        timeSection.appendChild(progressDiv);
    }
    
    // Insert before the last div
    var lastDiv = cardBody.querySelector('.d-flex:last-child');
    cardBody.insertBefore(timeSection, lastDiv);
}

function checkActiveTimeLog() {
    fetch('/get_active_time_log')
        .then(function(response) {
            if (response.ok) {
                return response.json();
            }
            return null;
        })
        .then(function(data) {
            if (data && data.task_id) {
                var button = document.querySelector('[data-task-id="' + data.task_id + '"].time-track-btn');
                var taskCard = button ? button.closest('.task-card') : null;
                
                if (button && taskCard) {
                    button.classList.add('active');
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.title = 'Stop tracking time';
                    taskCard.classList.add('time-tracking-active');
                    button.setAttribute('data-time-log-id', data.id);
                    
                    startTimerDisplay(data.task_id, button);
                }
            }
        })
        .catch(function(error) {
            console.log('No active time log found');
        });
}

// Initialize autocomplete functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeAutocomplete();
});

function initializeAutocomplete() {
    // Fetch team users for autocomplete
    fetch('/api/team-users')
        .then(response => response.json())
        .then(users => {
            setupAutocomplete('edit_assignee_input', 'edit_assignee_id', 'edit_assignee_dropdown', users, ['analyst', 'manager', 'director']);
            setupAutocomplete('edit_supervisor_input', 'edit_supervisor_id', 'edit_supervisor_dropdown', users, ['manager', 'director']);
        })
        .catch(error => {
            console.error('Failed to load team users:', error);
        });
}

function setupAutocomplete(inputId, hiddenId, dropdownId, users, roleFilter) {
    var input = document.getElementById(inputId);
    var hiddenInput = document.getElementById(hiddenId);
    var dropdown = document.getElementById(dropdownId);
    
    if (!input || !hiddenInput || !dropdown) return;
    
    // Filter users by role if specified
    var filteredUsers = roleFilter ? users.filter(user => roleFilter.includes(user.role)) : users;
    
    input.addEventListener('input', function() {
        var query = this.value.toLowerCase().trim();
        
        if (query.length < 1) {
            dropdown.style.display = 'none';
            return;
        }
        
        var matchingUsers = filteredUsers.filter(user => {
            var displayName = user.display_name || user.username;
            return displayName.toLowerCase().includes(query) || 
                   user.username.toLowerCase().includes(query);
        });
        
        if (matchingUsers.length > 0) {
            dropdown.innerHTML = '';
            matchingUsers.forEach(user => {
                var item = document.createElement('div');
                item.className = 'dropdown-item';
                var displayName = user.display_name || user.username;
                item.innerHTML = displayName + ' (' + user.username + ') - ' + user.role;
                item.onclick = function() {
                    input.value = displayName + ' (' + user.username + ')';
                    hiddenInput.value = user.id;
                    dropdown.style.display = 'none';
                };
                dropdown.appendChild(item);
            });
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Clear hidden input when text is manually cleared
    input.addEventListener('blur', function() {
        setTimeout(() => {
            if (this.value === '') {
                hiddenInput.value = '';
            }
        }, 200);
    });
}

// Approval and rejection functions
function approveTask(taskId) {
    if (!confirm('Are you sure you want to approve this task? It will be marked as completed.')) {
        return;
    }
    
    fetch('/approve_task/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showPriorityNotification(data.message, 'success');
            // Move task card dynamically from In Review to Completed
            moveTaskCardToColumn(taskId, 'completed');
        } else {
            showPriorityNotification(data.error || 'Failed to approve task', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error approving task:', error);
        showPriorityNotification('Failed to approve task', 'error');
    });
}

function rejectTask(taskId) {
    var reason = prompt('Please provide a reason for rejection (optional):');
    if (reason === null) return; // User cancelled
    
    fetch('/reject_task/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'reason=' + encodeURIComponent(reason || 'No reason provided')
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showPriorityNotification(data.message, 'success');
            // Move task card dynamically from In Review to In Progress
            moveTaskCardToColumn(taskId, 'in_progress');
        } else {
            showPriorityNotification(data.error || 'Failed to reject task', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error rejecting task:', error);
        showPriorityNotification('Failed to reject task', 'error');
    });
}

// Helper function to move task cards between columns
function moveTaskCardToColumn(taskId, newStatus) {
    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!taskCard) return;
    
    // Remove from current column
    taskCard.remove();
    
    // Add to target column
    let targetColumn;
    switch(newStatus) {
        case 'todo':
            targetColumn = document.querySelector('#todo-column .task-container');
            break;
        case 'in_progress':
            targetColumn = document.querySelector('#in-progress-column .task-container');
            break;
        case 'in_review':
            targetColumn = document.querySelector('#in-review-column .task-container');
            break;
        case 'completed':
            targetColumn = document.querySelector('#completed-column .task-container');
            break;
    }
    
    if (targetColumn) {
        // Update task card status class
        taskCard.classList.remove('status-todo', 'status-in_progress', 'status-in_review', 'status-completed');
        taskCard.classList.add(`status-${newStatus}`);
        
        // Remove approval/rejection buttons if moving away from in_review
        if (newStatus !== 'in_review') {
            const approveBtn = taskCard.querySelector('button[onclick*="approveTask"]');
            const rejectBtn = taskCard.querySelector('button[onclick*="rejectTask"]');
            if (approveBtn) approveBtn.remove();
            if (rejectBtn) rejectBtn.remove();
        }
        
        targetColumn.appendChild(taskCard);
        updateColumnCounts();
    }
}

// Admin action functions
function adminChangeTaskStatus(taskId, newStatus) {
    const statusNames = {
        'todo': 'To Do',
        'in_progress': 'In Progress', 
        'in_review': 'In Review',
        'completed': 'Completed'
    };
    const displayName = statusNames[newStatus] || newStatus;
    
    if (!confirm(`Are you sure you want to move this task to ${displayName}?`)) {
        return;
    }
    
    fetch('/update_task/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'status=' + encodeURIComponent(newStatus)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showPriorityNotification(`Task moved to ${displayName}`, 'success');
            // Move task card dynamically
            moveTaskCardToColumn(taskId, newStatus);
        } else {
            showPriorityNotification(data.error || 'Failed to update task status', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error updating task status:', error);
        showPriorityNotification('Failed to update task status', 'error');
    });
}

function adminDeleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        return;
    }
    
    fetch('/delete_task/' + taskId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(function(response) {
        if (response.ok) {
            showPriorityNotification('Task deleted successfully', 'success');
            // Remove task card from DOM
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.remove();
                updateColumnCounts();
            }
        } else {
            throw new Error('Failed to delete task');
        }
    })
    .catch(function(error) {
        console.error('Error deleting task:', error);
        showPriorityNotification('Failed to delete task', 'error');
    });
}

// Form validation for mandatory fields and workflow progression
function validateTaskForm(form) {
    const statusSelect = form.querySelector('select[name="task_status"]');
    const currentStatus = statusSelect ? statusSelect.value : 'todo';
    const dueDate = form.querySelector('input[name="due_date"]');
    const assigneeId = form.querySelector('input[name="assignee_id"]');
    const supervisorId = form.querySelector('input[name="supervisor_id"]');
    
    // Check if this is a To Do task with a Due Date being added
    const isDueDateAdded = currentStatus === 'todo' && dueDate && dueDate.value;
    
    if (isDueDateAdded) {
        // Validate required fields for progression to In Progress
        if (!assigneeId || !assigneeId.value) {
            alert('Assignee is required when adding a Due Date to move the task to In Progress.');
            if (assigneeId) assigneeId.focus();
            return false;
        }
        
        if (!supervisorId || !supervisorId.value) {
            alert('Supervisor is required when adding a Due Date to move the task to In Progress.');
            if (supervisorId) supervisorId.focus();
            return false;
        }
        
        // Automatically set status to in_progress
        if (statusSelect) {
            statusSelect.value = 'in_progress';
        }
        
        // Add hidden field to indicate automatic progression
        let autoProgressField = form.querySelector('input[name="auto_progress"]');
        if (!autoProgressField) {
            autoProgressField = document.createElement('input');
            autoProgressField.type = 'hidden';
            autoProgressField.name = 'auto_progress';
            autoProgressField.value = 'true';
            form.appendChild(autoProgressField);
        }
    }
    
    // If task is not in TODO status, make fields mandatory
    if (currentStatus !== 'todo') {
        if (!dueDate || !dueDate.value) {
            alert('Due Date is mandatory for tasks not in To Do status.');
            if (dueDate) dueDate.focus();
            return false;
        }
        
        if (!assigneeId || !assigneeId.value) {
            alert('Assignee is mandatory for tasks not in To Do status.');
            if (assigneeId) assigneeId.focus();
            return false;
        }
        
        if (!supervisorId || !supervisorId.value) {
            alert('Supervisor is mandatory for tasks not in To Do status.');
            if (supervisorId) supervisorId.focus();
            return false;
        }
    }
    
    return true;
}

// Load task data for editing
function loadTaskForEdit(taskId) {
    // Get task data from the page
    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!taskCard) {
        console.error('Task card not found');
        return;
    }
    
    // Extract task data from the task cards and form a basic structure
    // We'll make an AJAX call to get the full task data
    fetch(`/get_task_data/${taskId}`)
        .then(response => response.json())
        .then(task => {
            populateEditForm(task);
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading task data:', error);
            // Fallback to basic modal show
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            document.getElementById('editTaskForm').action = `/update_task/${taskId}`;
            modal.show();
        });
}

// Populate edit form with task data
function populateEditForm(task) {
    // Set form action
    document.getElementById('editTaskForm').action = `/update_task/${task.id}`;
    
    // Populate basic fields
    document.getElementById('edit_title').value = task.title || '';
    document.getElementById('edit_description').value = task.description || '';
    document.getElementById('edit_priority').value = task.priority || 'medium';
    document.getElementById('edit_complexity').value = task.complexity || 'medium';
    document.getElementById('edit_team_id').value = task.team_id || '';
    document.getElementById('edit_estimated_hours').value = task.estimated_hours || '';
    document.getElementById('edit_started_at').value = task.started_at ? task.started_at.split('T')[0] : '';
    document.getElementById('edit_due_date').value = task.due_date ? task.due_date.split('T')[0] : '';
    document.getElementById('edit_completed_at').value = task.completed_at ? task.completed_at.split('T')[0] : '';
    
    // Handle assignee autocomplete
    const assigneeInput = document.getElementById('edit_assignee_input');
    const assigneeHidden = document.getElementById('edit_assignee_id');
    if (task.assignee && assigneeInput && assigneeHidden) {
        assigneeInput.value = task.assignee.display_name || task.assignee.username;
        assigneeHidden.value = task.assignee.id;
    } else if (assigneeInput && assigneeHidden) {
        assigneeInput.value = '';
        assigneeHidden.value = '';
    }
    
    // Handle supervisor autocomplete
    const supervisorInput = document.getElementById('edit_supervisor_input');
    const supervisorHidden = document.getElementById('edit_supervisor_id');
    if (task.supervisor && supervisorInput && supervisorHidden) {
        supervisorInput.value = task.supervisor.display_name || task.supervisor.username;
        supervisorHidden.value = task.supervisor.id;
    } else if (supervisorInput && supervisorHidden) {
        supervisorInput.value = '';
        supervisorHidden.value = '';
    }
    
    // Set task status
    const statusSelect = document.getElementById('edit_task_status');
    if (statusSelect) {
        statusSelect.value = task.status || 'todo';
    }
}

// Initialize current user ID for My Tasks filter
window.currentUserId = '{{ current_user.id if current_user else "" }}';

// Initialize My Tasks filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const myTasksFilter = document.getElementById('myTasksFilter');
    if (myTasksFilter) {
        myTasksFilter.addEventListener('change', function() {
            filterMyTasks(this.value);
        });
    }
});

// Enhanced My Tasks filter function
function filterMyTasks(filterValue) {
    const taskCards = document.querySelectorAll('.task-card');
    const currentUserId = window.currentUserId;
    
    taskCards.forEach(card => {
        if (filterValue === 'my-tasks') {
            // Show tasks assigned to current user OR created by current user
            const assigneeId = card.dataset.assigneeId;
            const createdBy = card.dataset.createdBy;
            
            if ((assigneeId && assigneeId === currentUserId) || 
                (createdBy && createdBy === currentUserId)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        } else {
            // Show all tasks
            card.style.display = '';
        }
    });
    
    updateColumnCounts();
}

// Team filter function
function filterByTeam() {
    const teamFilter = document.getElementById('teamFilter');
    const selectedTeamId = teamFilter.value;
    const taskCards = document.querySelectorAll('.task-card');
    
    taskCards.forEach(card => {
        const taskTeamId = card.dataset.teamId;
        
        if (selectedTeamId === '' || taskTeamId === selectedTeamId) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
    
    updateColumnCounts();
}
</script>
<style>
    .kanban-column {
        min-height: 600px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .task-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid #0052CC;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .task-card.priority-urgent { border-left-color: #FF5630; }
    .task-card.priority-high { border-left-color: #FF8B00; }
    .task-card.priority-medium { border-left-color: #36B37E; }
    .task-card.priority-low { border-left-color: #0065FF; }
    
    /* Autocomplete dropdown styling */
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #fff;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .dropdown-item {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        clear: both;
        font-weight: 400;
        color: #212529;
        text-align: inherit;
        text-decoration: none;
        white-space: nowrap;
        background-color: transparent;
        border: 0;
        cursor: pointer;
    }
    
    .dropdown-item:hover,
    .dropdown-item.active {
        color: #fff;
        background-color: #006B68;
    }
    
    .dropdown-item:focus {
        outline: none;
        background-color: #006B68;
        color: #fff;
    }
    
    /* Priority badge styling - more specific selectors to prevent leaking */
    .priority-badge {
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        font-weight: 600;
        border: 2px solid transparent;
        display: inline-block;
    }
    
    .priority-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .priority-badge.priority-urgent {
        background-color: #FF5630 !important;
        color: white !important;
        border-color: #de350b !important;
    }
    
    .priority-badge.priority-high {
        background-color: #FF8B00 !important;
        color: white !important;
        border-color: #ff6300 !important;
    }
    
    .priority-badge.priority-medium {
        background-color: #36B37E !important;
        color: white !important;
        border-color: #00875a !important;
    }
    
    .priority-badge.priority-low {
        background-color: #0065FF !important;
        color: white !important;
        border-color: #0052cc !important;
    }
    
    .priority-badge.priority-loading {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    /* Disabled priority badge styling */
    .priority-badge.priority-disabled {
        opacity: 0.6 !important;
        cursor: default !important;
        background-color: #6c757d !important;
        color: #fff !important;
        border-color: #495057 !important;
    }
    
    .priority-badge.priority-disabled:hover {
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* Visual cues for editable vs non-editable */
    .priority-badge:not(.priority-disabled) {
        border: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
    }
    
    .priority-badge:not(.priority-disabled):hover::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
        border-radius: inherit;
        z-index: -1;
    }
    
    /* Priority notification styling */
    .priority-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .priority-notification.show {
        transform: translateX(0);
    }
    
    .priority-notification-success {
        background-color: #36B37E;
    }
    
    .priority-notification-error {
        background-color: #FF5630;
    }
    
    /* Enhanced priority selector */
    .priority-selector {
        position: relative;
    }
    
    .priority-selector:hover .priority-badge::after {
        content: "Click to change";
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        z-index: 1000;
    }
    
    /* Time tracking styling */
    .time-tracking-section {
        border-top: 1px solid #f0f0f0;
        padding-top: 8px;
    }
    
    .time-track-btn {
        padding: 2px 6px;
        font-size: 10px;
        line-height: 1;
        border-radius: 3px;
    }
    
    .time-track-btn.active {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    .time-track-btn.active i::before {
        content: "\f04d"; /* FontAwesome stop icon */
    }
    
    .progress {
        margin-top: 4px;
    }
    
    .time-controls {
        display: flex;
        gap: 4px;
    }
    
    /* Active time tracking indicator */
    .task-card.time-tracking-active {
        border-left: 4px solid #dc3545;
        box-shadow: 0 0 0 1px rgba(220, 53, 69, 0.2);
    }
    
    .time-tracking-active .time-track-btn {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-1">Banking Task Board</h1>
                    <p class="text-muted mb-0">Manage your banking operations efficiently</p>
                </div>
                {% if current_user and (current_user.role in ['manager', 'director'] or current_user.is_administrator) %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                    <i data-feather="plus" class="me-2"></i>
                    Create New Task
                </button>
                {% else %}
                <div class="text-muted">
                    <i data-feather="info" class="me-2"></i>
                    Only managers can create tasks
                </div>
                {% endif %}
            </div>
            
            <!-- Team Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i data-feather="filter"></i></span>
                        <select class="form-select" id="teamFilter" onchange="filterByTeam()">
                            <option value="">All Banking Teams</option>
                            {% for team in teams %}
                                <option value="{{ team.id }}" {% if selected_team == team.id|string %}selected{% endif %}>
                                    {{ team.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text"><i data-feather="user"></i></span>
                        <select class="form-select" id="myTasksFilter">
                            <option value="">All Tasks</option>
                            <option value="my-tasks">My Tasks Only</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center gap-3">
                        {% if selected_team %}
                            {% for team in teams %}
                                {% if team.id|string == selected_team %}
                                    <div class="badge bg-primary">
                                        <i data-feather="users" class="me-1" style="width: 12px; height: 12px;"></i>
                                        {{ team.name }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <small class="text-muted">
                            Showing {{ (todo_tasks + in_progress_tasks + in_review_tasks + completed_tasks)|length }} tasks
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="row g-4">
        <!-- Todo Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-secondary">
                        <i data-feather="circle" class="me-2"></i>
                        To Do
                    </h5>
                    <span class="badge bg-secondary">{{ todo_tasks|length }}</span>
                </div>
                
                <div class="task-container" id="todo-column">
                    {% for task in todo_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             data-assignee-id="{{ task.assignee_id or '' }}"
                             data-created-by="{{ task.created_by }}"
                             data-team-id="{{ task.team_id or '' }}"
                             onclick="loadTaskForEdit('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    {{ priority_badge(task, current_user) }}
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                                
                                <!-- Admin actions for TODO tasks -->
                                {% if current_user and current_user.is_administrator %}
                                <div class="mt-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                onclick="event.stopPropagation();" 
                                                data-bs-toggle="dropdown" aria-expanded="false" title="Admin Actions">
                                            <i data-feather="settings" style="width: 12px; height: 12px;"></i>
                                        </button>
                                        <ul class="dropdown-menu" onclick="event.stopPropagation();">
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'in_progress');">
                                                    <i data-feather="play" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to In Progress
                                                </button>
                                            </li>
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'in_review');">
                                                    <i data-feather="eye" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to Review
                                                </button>
                                            </li>
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'completed');">
                                                    <i data-feather="check-circle" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Mark Complete
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" onclick="adminDeleteTask('{{ task.id }}');">
                                                    <i data-feather="trash-2" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Delete Task
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-warning">
                        <i data-feather="clock" class="me-2"></i>
                        In Progress
                    </h5>
                    <span class="badge bg-warning">{{ in_progress_tasks|length }}</span>
                </div>
                
                <div class="task-container" id="in-progress-column">
                    {% for task in in_progress_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             data-assignee-id="{{ task.assignee_id or '' }}"
                             data-created-by="{{ task.created_by }}"
                             data-team-id="{{ task.team_id or '' }}"
                             onclick="loadTaskForEdit('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    {{ priority_badge(task, current_user) }}
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                                
                                <!-- Action buttons for In Progress tasks -->
                                <div class="mt-2">
                                    <!-- Send for Review Button (for assigned users) -->
                                    {% if current_user and task.assignee_id == current_user.id %}
                                    <form method="POST" action="{{ url_for('send_task_for_review', task_id=task.id) }}" class="d-inline me-1" onclick="event.stopPropagation();">
                                        <button type="submit" class="btn btn-sm btn-info" title="Send for Review">
                                            <i data-feather="send" style="width: 12px; height: 12px;"></i>
                                            Send for Review
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Admin actions dropdown -->
                                    {% if current_user and current_user.is_administrator %}
                                    <div class="dropdown d-inline">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                onclick="event.stopPropagation();" 
                                                data-bs-toggle="dropdown" aria-expanded="false" title="Admin Actions">
                                            <i data-feather="settings" style="width: 12px; height: 12px;"></i>
                                        </button>
                                        <ul class="dropdown-menu" onclick="event.stopPropagation();">
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'todo');">
                                                    <i data-feather="square" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to TODO
                                                </button>
                                            </li>
                                            <!-- Admin send for review (if not already shown) -->
                                            {% if not (current_user.role == 'analyst' and task.assignee_id == current_user.id) %}
                                            <li>
                                                <form method="POST" action="{{ url_for('send_task_for_review', task_id=task.id) }}" class="dropdown-item-form">
                                                    <button type="submit" class="dropdown-item">
                                                        <i data-feather="send" style="width: 12px; height: 12px;" class="me-1"></i>
                                                        Admin Send for Review
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'completed');">
                                                    <i data-feather="check-circle" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Mark Complete
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" onclick="adminDeleteTask('{{ task.id }}');">
                                                    <i data-feather="trash-2" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Delete Task
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- In Review Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-info">
                        <i data-feather="eye" class="me-2"></i>
                        In Review
                    </h5>
                    <span class="badge bg-info">{{ in_review_tasks|length }}</span>
                </div>
                
                <div class="task-container" id="in-review-column">
                    {% for task in in_review_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             data-assignee-id="{{ task.assignee_id or '' }}"
                             data-created-by="{{ task.created_by }}"
                             data-team-id="{{ task.team_id or '' }}"
                             onclick="loadTaskForEdit('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    {{ priority_badge(task, current_user) }}
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    {% if task.supervisor %}
                                        <small class="text-muted">Supervisor: {{ task.supervisor.display_name or task.supervisor.username }}</small>
                                    {% endif %}
                                </div>
                                
                                <!-- Action buttons for In Review tasks -->
                                <div class="mt-2">
                                    <!-- Regular role-based actions (visible to all users based on their actual role) -->
                                    {% if current_user %}
                                        <!-- Recall button for analysts -->
                                        {% if current_user.role == 'analyst' and task.assignee_id == current_user.id %}
                                        <form method="POST" action="{{ url_for('recall_task', task_id=task.id) }}" class="d-inline me-1" onclick="event.stopPropagation();">
                                            <button type="submit" class="btn btn-sm btn-warning" title="Recall from Review">
                                                <i data-feather="arrow-left" style="width: 12px; height: 12px;"></i>
                                                Recall
                                            </button>
                                        </form>
                                        {% endif %}
                                        
                                        <!-- Approve/Reject buttons for supervisors -->
                                        {% if task.supervisor_id == current_user.id %}
                                        <button type="button" class="btn btn-sm btn-success me-1" title="Approve & Complete" 
                                                onclick="event.stopPropagation(); approveTask('{{ task.id }}');">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                            Approve
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger me-1" title="Reject & Send Back" 
                                                onclick="event.stopPropagation(); rejectTask('{{ task.id }}');">
                                            <i data-feather="x" style="width: 12px; height: 12px;"></i>
                                            Reject
                                        </button>
                                        {% endif %}
                                        
                                        <!-- Administrator menu (collapsed by default) -->
                                        {% if current_user.is_administrator %}
                                        <div class="dropdown d-inline">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                    onclick="event.stopPropagation();" 
                                                    data-bs-toggle="dropdown" aria-expanded="false" title="Admin Actions">
                                                <i data-feather="settings" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <ul class="dropdown-menu" onclick="event.stopPropagation();">
                                                <!-- Admin recall action (if not already shown) -->
                                                {% if not (current_user.role == 'analyst' and task.assignee_id == current_user.id) %}
                                                <li>
                                                    <form method="POST" action="{{ url_for('recall_task', task_id=task.id) }}" class="dropdown-item-form">
                                                        <button type="submit" class="dropdown-item">
                                                            <i data-feather="arrow-left" style="width: 12px; height: 12px;" class="me-1"></i>
                                                            Admin Recall
                                                        </button>
                                                    </form>
                                                </li>
                                                {% endif %}
                                                <!-- Admin approve action (if not already shown) -->
                                                {% if task.supervisor_id != current_user.id %}
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="approveTask('{{ task.id }}');">
                                                        <i data-feather="check" style="width: 12px; height: 12px;" class="me-1"></i>
                                                        Admin Approve
                                                    </button>
                                                </li>
                                                <li>
                                                    <button type="button" class="dropdown-item" 
                                                            onclick="rejectTask('{{ task.id }}');">
                                                        <i data-feather="x" style="width: 12px; height: 12px;" class="me-1"></i>
                                                        Admin Reject
                                                    </button>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Completed Column -->
        <div class="col-lg-3">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-success">
                        <i data-feather="check-circle" class="me-2"></i>
                        Completed
                    </h5>
                    <span class="badge bg-success">{{ completed_tasks|length }}</span>
                </div>
                
                <div class="task-container" id="completed-column">
                    {% for task in completed_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             data-assignee-id="{{ task.assignee_id or '' }}"
                             data-created-by="{{ task.created_by }}"
                             data-team-id="{{ task.team_id or '' }}"
                             onclick="loadTaskForEdit('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    {{ priority_badge(task, current_user) }}
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                                
                                <!-- Admin actions for Completed tasks -->
                                {% if current_user and current_user.is_administrator %}
                                <div class="mt-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                onclick="event.stopPropagation();" 
                                                data-bs-toggle="dropdown" aria-expanded="false" title="Admin Actions">
                                            <i data-feather="settings" style="width: 12px; height: 12px;"></i>
                                        </button>
                                        <ul class="dropdown-menu" onclick="event.stopPropagation();">
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'todo');">
                                                    <i data-feather="square" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to TODO
                                                </button>
                                            </li>
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'in_progress');">
                                                    <i data-feather="play" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to In Progress
                                                </button>
                                            </li>
                                            <li>
                                                <button type="button" class="dropdown-item" onclick="adminChangeTaskStatus('{{ task.id }}', 'in_review');">
                                                    <i data-feather="eye" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Move to Review
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" onclick="adminDeleteTask('{{ task.id }}');">
                                                    <i data-feather="trash-2" style="width: 12px; height: 12px;" class="me-1"></i>
                                                    Delete Task
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Create New Task</h4>
                    <p class="text-muted small mb-0">Add a task to your banking workflow</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" action="{{ url_for('create_task') }}" id="createTaskForm">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    

                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="assignee_input" class="form-label fw-medium mb-2">Assign To</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control clean-input" id="assignee_input" 
                                           placeholder="Type name to search team members..." autocomplete="off">
                                    <input type="hidden" id="assignee_id" name="assignee_id">
                                    <div class="dropdown-menu" id="assignee_dropdown" style="display: none; width: 100%; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Supervisor -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="supervisor_input" class="form-label fw-medium mb-2">
                                    <i data-feather="user-check" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Supervisor
                                </label>
                                <div class="position-relative">
                                    <input type="text" class="form-control clean-input" id="supervisor_input" 
                                           placeholder="Type name to search team managers..." autocomplete="off">
                                    <input type="hidden" id="supervisor_id" name="supervisor_id">
                                    <div class="dropdown-menu" id="supervisor_dropdown" style="display: none; width: 100%; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <div class="form-text">Optional: Choose a team manager to supervise this task</div>
                            </div>
                            
                            <!-- Team automatically set to manager's team -->
                            {% if current_user and current_user.team %}
                            <div class="mb-4">
                                <label class="form-label fw-medium mb-2">Banking Team</label>
                                <div class="form-control clean-input bg-light text-muted">
                                    <i data-feather="users" class="me-2" style="width: 16px; height: 16px;"></i>
                                    {{ current_user.team.name }} (Auto-assigned)
                                </div>
                                <div class="form-text">Tasks are automatically assigned to your team</div>
                            </div>
                            {% endif %}
                            
                            <div class="mb-4">
                                <label for="estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="estimated_hours" 
                                       name="estimated_hours" min="0.1" max="200" step="0.1" 
                                       placeholder="e.g. 4.25">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                        
                        <!-- Start Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="started_at" class="form-label fw-medium mb-2">
                                    <i data-feather="play-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control clean-input" id="started_at" 
                                       name="started_at">
                                <div class="form-text">When work on this task will begin</div>
                            </div>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="due_date" class="form-label fw-medium mb-2">
                                    <i data-feather="calendar" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Due Date
                                </label>
                                <input type="date" class="form-control clean-input" id="due_date" 
                                       name="due_date">
                                <div class="form-text">Target completion date</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Edit Task</h4>
                    <p class="text-muted small mb-0">Update task details</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" id="editTaskForm" onsubmit="return validateTaskForm(this);">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="edit_title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="edit_title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="edit_description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="edit_description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="edit_priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="edit_complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium">Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        

                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_assignee_input" class="form-label fw-medium mb-2">Assign To</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control clean-input" id="edit_assignee_input" 
                                           placeholder="Type name to search team members..." autocomplete="off">
                                    <input type="hidden" id="edit_assignee_id" name="assignee_id">
                                    <div class="dropdown-menu" id="edit_assignee_dropdown" style="display: none; width: 100%; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Supervisor -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_supervisor_input" class="form-label fw-medium mb-2">
                                    <i data-feather="user-check" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Supervisor
                                </label>
                                <div class="position-relative">
                                    <input type="text" class="form-control clean-input" id="edit_supervisor_input" 
                                           placeholder="Type name to search team managers..." autocomplete="off">
                                    <input type="hidden" id="edit_supervisor_id" name="supervisor_id">
                                    <div class="dropdown-menu" id="edit_supervisor_dropdown" style="display: none; width: 100%; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Team Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_team_id" class="form-label fw-medium mb-2">Banking Team</label>
                                <select class="form-select clean-input" id="edit_team_id" name="team_id">
                                    <option value="">Select team...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Time Estimate -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="edit_estimated_hours" 
                                       name="estimated_hours" min="0.1" max="200" step="0.1" 
                                       placeholder="e.g. 4.25">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                        
                        <!-- Start Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_started_at" class="form-label fw-medium mb-2">
                                    <i data-feather="play-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_started_at" 
                                       name="started_at">
                                <div class="form-text">When work on this task began</div>
                            </div>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_due_date" class="form-label fw-medium mb-2">
                                    <i data-feather="calendar" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Due Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_due_date" 
                                       name="due_date">
                                <div class="form-text">Target completion date</div>
                            </div>
                        </div>
                        
                        <!-- Completed Date -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_completed_at" class="form-label fw-medium mb-2">
                                    <i data-feather="check-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Completed Date
                                </label>
                                <input type="date" class="form-control clean-input" id="edit_completed_at" 
                                       name="completed_at" readonly>
                                <div class="form-text">Automatically set when task is completed</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Attachments Section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-4">
                                <label class="form-label fw-medium mb-2">
                                    <i data-feather="paperclip" class="me-1" style="width: 16px; height: 16px;"></i>
                                    File Attachments
                                </label>
                                
                                <!-- File Upload Area -->
                                <div class="upload-area border rounded p-3 mb-3" style="border: 2px dashed #e1e5e9;">
                                    <div class="text-center">
                                        <i data-feather="upload" class="text-muted mb-2" style="width: 24px; height: 24px;"></i>
                                        <p class="mb-2 text-muted">Drag files here or click to browse</p>
                                        <input type="file" id="fileUpload" class="d-none" multiple 
                                               accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.csv">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileUpload').click()">
                                            <i data-feather="plus" class="me-1" style="width: 12px; height: 12px;"></i>
                                            Add Files
                                        </button>
                                        <div class="form-text mt-2">
                                            Max file size: 16MB. Supported: PDF, Images, Office docs, Text files, Archives
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Existing Attachments List -->
                                <div id="attachmentsList" class="attachments-list">
                                    <!-- Attachments will be loaded here -->
                                </div>
                                
                                <!-- Upload Progress -->
                                <div id="uploadProgress" class="d-none">
                                    <div class="progress mb-2">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted">Uploading files...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn">
                        <i data-feather="trash-2" class="me-1" style="width: 16px; height: 16px;"></i>
                        Delete
                    </button>
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Update Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Clean Modal Styling */
.clean-modal {
    border: none;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
}

.clean-modal .modal-header {
    padding: 2rem 2rem 1rem 2rem;
}

.clean-modal .modal-body {
    padding: 0 2rem;
}

.clean-modal .modal-footer {
    padding: 1rem 2rem 2rem 2rem;
}

/* Clean Input Styling */
.clean-input {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #fff;
}

.clean-input:focus {
    border-color: #0052CC;
    box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    outline: none;
}

.clean-input::placeholder {
    color: #9ca3af;
}

/* Form Labels */
.form-label.fw-medium {
    color: #374151;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

/* Template Buttons */
.template-btn {
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.template-btn:hover {
    transform: translateY(-1px);
}

/* Priority Button Styling */
.btn-check:checked + .btn {
    transform: none;
}

.btn-outline-secondary:hover,
.btn-outline-success:hover,
.btn-outline-warning:hover,
.btn-outline-danger:hover {
    transform: translateY(-1px);
}

/* Modal Animation */
.modal.fade .modal-dialog {
    transform: scale(0.95);
    transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: scale(1);
}

/* Clean Button Styling */
.btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn-primary {
    background: #0052CC;
    border-color: #0052CC;
}

.btn-primary:hover {
    background: #003d99;
    border-color: #003d99;
}

.btn-light {
    background: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.btn-light:hover {
    background: #e9ecef;
    border-color: #dfe3e8;
    color: #495057;
}

/* File Upload Styling */
.upload-area {
    transition: all 0.2s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #0052CC !important;
    background-color: #f8f9ff !important;
}

.attachment-item {
    transition: all 0.2s ease;
}

.attachment-item:hover {
    background-color: #f8f9fa;
    border-color: #0052CC !important;
}

/* Priority Button Styling */
.priority-btn {
    border: none !important;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.priority-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.priority-btn.priority-loading {
    opacity: 0.6;
    pointer-events: none;
}

.priority-btn.priority-updated {
    animation: priorityPulse 0.5s ease;
}

@keyframes priorityPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Priority Color Schemes */
.priority-btn.priority-low {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #90caf9 !important;
}

.priority-btn.priority-low:hover {
    background-color: #bbdefb;
    color: #1565c0;
}

.priority-btn.priority-medium {
    background-color: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #81c784 !important;
}

.priority-btn.priority-medium:hover {
    background-color: #c8e6c9;
    color: #1b5e20;
}

.priority-btn.priority-high {
    background-color: #fff3e0;
    color: #f57c00;
    border: 1px solid #ffb74d !important;
}

.priority-btn.priority-high:hover {
    background-color: #ffe0b2;
    color: #e65100;
}

.priority-btn.priority-urgent {
    background-color: #ffebee;
    color: #d32f2f;
    border: 1px solid #ef5350 !important;
}

.priority-btn.priority-urgent:hover {
    background-color: #ffcdd2;
    color: #b71c1c;
}

/* Task Card Priority Borders */
.task-card.priority-low {
    border-left: 4px solid #2196f3;
}

.task-card.priority-medium {
    border-left: 4px solid #4caf50;
}

.task-card.priority-high {
    border-left: 4px solid #ff9800;
}

.task-card.priority-urgent {
    border-left: 4px solid #f44336;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.15);
}
</style>

<script>
// Welcome animation for successful login
// Set current user ID for JavaScript filtering
window.currentUserId = '{{ current_user.id if current_user else "" }}';

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're coming from a successful login
    const urlParams = new URLSearchParams(window.location.search);
    const fromLogin = urlParams.get('welcome') === 'true' || sessionStorage.getItem('loginSuccess') === 'true';
    
    if (fromLogin) {
        // Clear the session storage flag
        sessionStorage.removeItem('loginSuccess');
        
        // Add page entrance animation
        document.body.classList.add('page-enter');
        
        // Trigger the animation
        setTimeout(() => {
            document.body.classList.add('page-enter-active');
        }, 50);
        
        // Clean up URL parameter
        if (urlParams.get('welcome')) {
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);
        }
    }
});

// Team filtering is now handled by event listener in DOMContentLoaded

// Task creation templates
const templates = {
    risk: {
        title: "Risk Assessment - Q4 Portfolio Review",
        description: "Conduct comprehensive risk analysis including risk identification, impact assessment, mitigation strategies, and compliance verification."
    },
    compliance: {
        title: "Compliance Review - Regulatory Requirements",
        description: "Perform regulatory compliance review including policy validation, control testing, gap analysis, and compliance reporting."
    },
    analysis: {
        title: "Market Analysis - VaR Calculations",
        description: "Execute market risk analysis including data validation, VaR calculations, stress testing, and portfolio performance analysis."
    },
    audit: {
        title: "Audit Task - Control Evaluation",
        description: "Complete audit procedures including documentation review, control assessment, sample testing, and finding documentation."
    }
};

// Clean modal functionality
function initializeModal() {
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    
    // Template button handlers
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const template = templates[this.dataset.template];
            if (template) {
                titleInput.value = template.title;
                descriptionInput.value = template.description;
            }
        });
    });
    
    // Form submission with loading state
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
        submitBtn.disabled = true;
    });
    
    // Reset form when modal is hidden
    document.getElementById('createTaskModal').addEventListener('hidden.bs.modal', function() {
        const form = document.getElementById('createTaskForm');
        form.reset();
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = 'Create Task';
        submitBtn.disabled = false;
    });
}





// Delete task functionality
function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete_task/' + taskId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Handle delete button click
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteTaskBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const form = document.getElementById('editTaskForm');
            if (form) {
                const taskId = form.action.split('/').pop();
                deleteTask(taskId);
            }
        });
    }
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    initializeModal();
    
    // Initialize file upload
    if (typeof initializeFileUpload === 'function') {
        initializeFileUpload();
    }
    
    // Initialize kanban if function exists
    if (typeof initializeKanban === 'function') {
        initializeKanban();
    }
    
    // Setup edit functionality
    console.log('Setting up edit functionality');
    setupEditHandlers();
    
    // Setup team filter
    const teamFilter = document.getElementById('teamFilter');
    if (teamFilter) {
        teamFilter.addEventListener('change', function() {
            if (this.value) {
                window.location.href = '/?team=' + this.value;
            } else {
                window.location.href = '/';
            }
        });
    }
});

// Setup edit handlers function
function setupEditHandlers() {
    document.addEventListener('click', function(e) {
        const taskCard = e.target.closest('.task-card');
        if (taskCard && !e.target.closest('button')) {
            e.preventDefault();
            const taskId = taskCard.dataset.taskId;
            console.log('Task card clicked, ID:', taskId);
            if (taskId) {
                openTaskEditModal(taskId);
            }
        }
    });
}


</script>

<!-- Kanban Board JavaScript -->
<script src="{{ url_for('static', filename='js/kanban.js') }}"></script>
{% endblock %}