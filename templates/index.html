{% extends "base.html" %}

{% block title %}Banking Task Board - TaskFlow{% endblock %}

{% block extra_head %}
<style>
    .kanban-column {
        min-height: 600px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .task-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 4px solid #0052CC;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .priority-urgent { border-left-color: #FF5630; }
    .priority-high { border-left-color: #FF8B00; }
    .priority-medium { border-left-color: #36B37E; }
    .priority-low { border-left-color: #0065FF; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h3 mb-1">Banking Task Board</h1>
                    <p class="text-muted mb-0">Manage your banking operations efficiently</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                    <i data-feather="plus" class="me-2"></i>
                    Create New Task
                </button>
            </div>
            
            <!-- Team Filter -->
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i data-feather="filter"></i></span>
                        <select class="form-select" id="teamFilter" onchange="filterByTeam()">
                            <option value="">All Banking Teams</option>
                            {% for team in teams %}
                                <option value="{{ team.id }}" {% if selected_team == team.id|string %}selected{% endif %}>
                                    {{ team.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-3">
                        {% if selected_team %}
                            {% for team in teams %}
                                {% if team.id|string == selected_team %}
                                    <div class="badge bg-primary">
                                        <i data-feather="users" class="me-1" style="width: 12px; height: 12px;"></i>
                                        {{ team.name }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <small class="text-muted">
                            Showing {{ (todo_tasks + in_progress_tasks + completed_tasks)|length }} tasks
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="row g-4">
        <!-- Todo Column -->
        <div class="col-lg-4">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-secondary">
                        <i data-feather="circle" class="me-2"></i>
                        To Do
                    </h5>
                    <span class="badge bg-secondary">{{ todo_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in todo_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-primary ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="col-lg-4">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-warning">
                        <i data-feather="clock" class="me-2"></i>
                        In Progress
                    </h5>
                    <span class="badge bg-warning">{{ in_progress_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in in_progress_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-warning ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Completed Column -->
        <div class="col-lg-4">
            <div class="kanban-column">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 text-success">
                        <i data-feather="check-circle" class="me-2"></i>
                        Completed
                    </h5>
                    <span class="badge bg-success">{{ completed_tasks|length }}</span>
                </div>
                
                <div class="task-container">
                    {% for task in completed_tasks %}
                        <div class="card task-card mb-3 priority-{{ task.priority }}" 
                             data-task-id="{{ task.id }}" 
                             onclick="openEditModal('{{ task.id }}')"
                             style="cursor: pointer;">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 flex-grow-1">{{ task.title }}</h6>
                                    <span class="badge bg-success ms-2">{{ task.priority|upper }}</span>
                                </div>
                                
                                <p class="card-text text-muted small mb-2">
                                    {{ task.description|truncate(80) if task.description else "No description" }}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Task #{{ task.id }}</small>
                                    <small class="text-muted">{{ task.priority|title }}</small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Create New Task</h4>
                    <p class="text-muted small mb-0">Add a task to your banking workflow</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" action="{{ url_for('create_task') }}" id="createTaskForm">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    

                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="assignee_id" class="form-label fw-medium mb-2">Assign To</label>
                                <select class="form-select clean-input" id="assignee_id" name="assignee_id">
                                    <option value="">Select team member...</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="team_id" class="form-label fw-medium mb-2">Banking Team</label>
                                <select class="form-select clean-input" id="team_id" name="team_id">
                                    <option value="">Select team...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="estimated_hours" 
                                       name="estimated_hours" min="0.5" max="200" step="0.5" 
                                       placeholder="e.g. 4.5">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content clean-modal">
            <div class="modal-header border-0">
                <div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Edit Task</h4>
                    <p class="text-muted small mb-0">Update task details</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="POST" id="editTaskForm">
                <div class="modal-body p-4">
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="edit_title" class="form-label fw-medium mb-2">Task Title</label>
                        <input type="text" class="form-control form-control-lg clean-input" 
                               id="edit_title" name="title" required
                               placeholder="Enter task title...">
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label for="edit_description" class="form-label fw-medium mb-2">Description</label>
                        <textarea class="form-control clean-input" id="edit_description" name="description" 
                                  rows="4" placeholder="Describe the task objectives and requirements..."></textarea>
                    </div>
                    
                    <div class="row">
                        <!-- Priority Selection -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_priority" class="form-label fw-medium mb-2">Priority Level</label>
                                <select class="form-select clean-input" id="edit_priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_complexity" class="form-label fw-medium mb-2">Complexity Level</label>
                                <select class="form-select clean-input" id="edit_complexity" name="complexity">
                                    <option value="very_simple">Very Simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium">Medium</option>
                                    <option value="complex">Complex</option>
                                    <option value="very_complex">Very Complex</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_status" class="form-label fw-medium mb-2">Status</label>
                                <select class="form-select clean-input" id="edit_status" name="task_status">
                                    <option value="todo">To Do</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_assignee_id" class="form-label fw-medium mb-2">Assign To</label>
                                <select class="form-select clean-input" id="edit_assignee_id" name="assignee_id">
                                    <option value="">Select team member...</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Team Assignment -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_team_id" class="form-label fw-medium mb-2">Banking Team</label>
                                <select class="form-select clean-input" id="edit_team_id" name="team_id">
                                    <option value="">Select team...</option>
                                    {% for team in teams %}
                                        <option value="{{ team.id }}">{{ team.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Time Estimate -->
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="edit_estimated_hours" class="form-label fw-medium mb-2">
                                    <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                    Time Estimate (hours)
                                </label>
                                <input type="number" class="form-control clean-input" id="edit_estimated_hours" 
                                       name="estimated_hours" min="0.5" max="200" step="0.5" 
                                       placeholder="e.g. 4.5">
                                <div class="form-text">Optional: Estimated time to complete this task</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn">
                        <i data-feather="trash-2" class="me-1" style="width: 16px; height: 16px;"></i>
                        Delete
                    </button>
                    <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        Update Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Clean Modal Styling */
.clean-modal {
    border: none;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
}

.clean-modal .modal-header {
    padding: 2rem 2rem 1rem 2rem;
}

.clean-modal .modal-body {
    padding: 0 2rem;
}

.clean-modal .modal-footer {
    padding: 1rem 2rem 2rem 2rem;
}

/* Clean Input Styling */
.clean-input {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #fff;
}

.clean-input:focus {
    border-color: #0052CC;
    box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
    outline: none;
}

.clean-input::placeholder {
    color: #9ca3af;
}

/* Form Labels */
.form-label.fw-medium {
    color: #374151;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

/* Template Buttons */
.template-btn {
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.template-btn:hover {
    transform: translateY(-1px);
}

/* Priority Button Styling */
.btn-check:checked + .btn {
    transform: none;
}

.btn-outline-secondary:hover,
.btn-outline-success:hover,
.btn-outline-warning:hover,
.btn-outline-danger:hover {
    transform: translateY(-1px);
}

/* Modal Animation */
.modal.fade .modal-dialog {
    transform: scale(0.95);
    transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: scale(1);
}

/* Clean Button Styling */
.btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn-primary {
    background: #0052CC;
    border-color: #0052CC;
}

.btn-primary:hover {
    background: #003d99;
    border-color: #003d99;
}

.btn-light {
    background: #f8f9fa;
    border-color: #e9ecef;
    color: #6c757d;
}

.btn-light:hover {
    background: #e9ecef;
    border-color: #dfe3e8;
    color: #495057;
}
</style>

<script>
// Define edit functionality globally first
window.openEditModal = function(taskId) {
    console.log('Opening edit modal for task:', taskId);
    
    const task = window.tasksData?.find(t => t.id == taskId);
    if (!task) {
        alert('Task not found');
        return;
    }
    
    // Populate form
    document.getElementById('edit_title').value = task.title || '';
    document.getElementById('edit_description').value = task.description || '';
    document.getElementById('edit_assignee_id').value = task.assignee_id || '';
    document.getElementById('edit_priority').value = task.priority || 'medium';
    document.getElementById('edit_complexity').value = task.complexity || 'medium';
    document.getElementById('edit_status').value = task.status || 'todo';
    document.getElementById('edit_team_id').value = task.team_id || '';
    document.getElementById('edit_estimated_hours').value = task.estimated_hours || '';
    
    document.getElementById('editTaskForm').action = `/update_task/${taskId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
    modal.show();
};

// Team filtering
function filterByTeam() {
    const teamSelect = document.getElementById('teamFilter');
    const selectedTeam = teamSelect.value;
    
    if (selectedTeam) {
        window.location.href = `/?team=${selectedTeam}`;
    } else {
        window.location.href = '/';
    }
}

// Task creation templates
const templates = {
    risk: {
        title: "Risk Assessment - Q4 Portfolio Review",
        description: "Conduct comprehensive risk analysis including risk identification, impact assessment, mitigation strategies, and compliance verification."
    },
    compliance: {
        title: "Compliance Review - Regulatory Requirements",
        description: "Perform regulatory compliance review including policy validation, control testing, gap analysis, and compliance reporting."
    },
    analysis: {
        title: "Market Analysis - VaR Calculations",
        description: "Execute market risk analysis including data validation, VaR calculations, stress testing, and portfolio performance analysis."
    },
    audit: {
        title: "Audit Task - Control Evaluation",
        description: "Complete audit procedures including documentation review, control assessment, sample testing, and finding documentation."
    }
};

// Clean modal functionality
function initializeModal() {
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    
    // Template button handlers
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const template = templates[this.dataset.template];
            if (template) {
                titleInput.value = template.title;
                descriptionInput.value = template.description;
            }
        });
    });
    
    // Form submission with loading state
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
        submitBtn.disabled = true;
    });
    
    // Reset form when modal is hidden
    document.getElementById('createTaskModal').addEventListener('hidden.bs.modal', function() {
        const form = document.getElementById('createTaskForm');
        form.reset();
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = 'Create Task';
        submitBtn.disabled = false;
    });
}

// Task data for editing
window.tasksData = [
    {% for task in todo_tasks + in_progress_tasks + completed_tasks %}
    {
        id: "{{ task.id }}",
        title: "{{ task.title|e }}",
        description: "{{ task.description|e if task.description else '' }}",
        status: "{{ task.status }}",
        priority: "{{ task.priority }}",
        complexity: "{{ task.complexity if task.complexity else 'medium' }}",
        assignee_id: "{{ task.assignee_id if task.assignee_id else '' }}",
        team_id: "{{ task.team_id if task.team_id else '' }}",
        estimated_hours: "{{ task.estimated_hours if task.estimated_hours else '' }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];



// Delete task functionality
function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete_task/' + taskId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Handle delete button click
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteTaskBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            const form = document.getElementById('editTaskForm');
            if (form) {
                const taskId = form.action.split('/').pop();
                deleteTask(taskId);
            }
        });
    }
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    initializeModal();
    
    // Initialize kanban if function exists
    if (typeof initializeKanban === 'function') {
        initializeKanban();
    }
});
</script>

<!-- Kanban Board JavaScript -->
<script src="{{ url_for('static', filename='js/kanban.js') }}"></script>
{% endblock %}